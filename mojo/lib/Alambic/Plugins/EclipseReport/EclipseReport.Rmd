---
title: "Eclipse Project Report"
author: "Alambic"
header-includes:
   - \usepackage{tabularx}
   - \usepackage{fontawesome}
   - \usepackage{enumitem}
output: 
  pdf_document:
    highlight: tango
    latex_engine: xelatex
    keep_tex: true
---

```{r init, echo=FALSE, message=FALSE}
# Main information
project.id <- 'tools.cdt'
plugin.id <- 'EclipseReport'

library(knitr)

knitr::opts_chunk$set(fig.path = paste( 'figures/', plugin.id, '/', project.id, '/', sep=""))
opts_knit$set(progress=TRUE, echo=FALSE, verbose=TRUE, self.contained=T)

require(ggplot2)
library(reshape2)
require(xtable)
require(pander)
require(stringi)
require(ggthemes)

sanitize <- function(dirty) {
  # Remove weird chars for latex
  clean <- stri_replace_all_fixed(dirty, "\\", "\\\\")
  clean <- stri_replace_all_fixed(clean, "_", "\\_")
  clean <- stri_replace_all_fixed(clean, "$", "\\$")
  clean <- stri_replace_all_fixed(clean, "^", "\\^")
  # Remove HTML tags.
  clean <- gsub("<.*?>", "", clean)
  return(clean)
}

# Read files
main <- read.csv(file=paste("", project.id, "_main.csv", sep=""), header=T)
info <- read.csv(file=paste("", project.id, "_info.csv", sep=""), header=T)
metrics <- read.csv(file=paste("", project.id, "_metrics.csv", sep=""), header=T)
attributes <- read.csv(file=paste("", project.id, "_attributes.csv", sep=""), header=T)
recs <- read.csv(file=paste("", project.id, "_recs.csv", sep=""), header=T, row.names=NULL)

# Basic information about project
project.name <- info[info$Mnemo == 'pmi_title',2]
project.desc <- info[info$Mnemo == 'pmi_desc',2]
run.last <- ''

# PMI
file.pmi.checks <- paste("../../../../projects/", project.id, '/output/', project.id, "_pmi_checks.csv", sep="")
pmi.checks <- read.csv(file=file.pmi.checks, header=T, row.names=NULL)

# ITS
file.its.evol <- paste("../../../../projects/", project.id, '/output/', project.id, "_metrics_its_evol.csv", sep="")
its.evol <- read.csv(file=file.its.evol, header=T)
its.evol <- its.evol[its.evol$changed != 0,]

```

# Project Information

Name: `r project.name` 

\Large\faCheck qsdf
\normalsize

Description: 

> `r project.desc`

Last analysis of project was run on `r run.last`. This report has been generated on `r Sys.time()`.

```{r ci_init, echo=F, results='asis', comment=NA, prompt=FALSE, eval=grepl('^http', info[info$Mnemo == 'pmi_ci_url', c('Value')])}
r_ci <- "Continuous integration is setup and information is provided in the PMI. "
#cat(r_ci)
```

```{r ci_init_ifelse, echo=F, results='asis', comment=NA, prompt=FALSE}
info_c <- sanitize( info[info$Mnemo == 'pmi_ci_url', c('Value')] )
r_ci_if <- ifelse(
  grepl('^http', info_c),
  paste( "Continuous integration is setup and information is provided in the PMI. URL is ", info_c, ".", sep=""),
  "Continuous integration is either not setup or not correctly set in the PMI."
)
#cat(ci_ok)
```

\begin{itemize}
\item `r I(r_ci_if)`
\end{itemize}


# Documentation

```{r doc_init_ifelse, echo=F, results='asis', comment=NA, prompt=FALSE}
info_c <- sanitize( info[info$Mnemo == 'pmi_wiki_url', c('Value')] )
r_doc_wiki <- ifelse(
  grepl('^http', info[info$Mnemo == 'pmi_wiki_url', c('Value')]),
  paste( "The project uses a wiki, located at ", info_c, ".", sep=""),
  "The project either did not setup a wiki or forgot to fill the PMI entry."
)
#cat(ci_ok)
```

The main page of the project is located at `r info[info$Mnemo == 'pmi_main_url', c('Value')]`. 
`r I(r_doc_wiki)`


# Project Management Infrastructure

This section retrieves metadata for the project from the Project Management Infrastructure. The URL.

```{r pmi.checks, echo=F, message=FALSE, warnings=FALSE, results='asis', eval=T}
panderOptions('table.split.table', Inf)
set.caption( paste( "PMI Checks for project ", project.id, sep="" ) )
pmi.checks.ok <- pmi.checks[grepl("^OK", pmi.checks$Results),]
pmi.checks.nok <- pmi.checks[grepl("^Failed", pmi.checks$Results),]

pmi.checks.clean <- t(apply( pmi.checks, 1, sanitize ))
pmi.checks.list <- apply( pmi.checks.clean, 1, 
                          function(x) paste( '\\begin{description}[align=left]\n',
                                             '\\item [Description]', x[1], '',
                                             '\\item[Value]', x[2], '', 
                                             '\\item[Results]', x[3], '\n',
                                             '\\end{description}\n', sep="") )
pmi.checks.list <- paste( pmi.checks.list, sep="" )
cat(pmi.checks.list)
#pandoc.table(pmi.checks.clean, style = 'multiline', justify = c('left', 'left', 'left'))
```

# Issue Tracking System

```{r its_init_ifelse, echo=F, results='asis', comment=NA, prompt=FALSE}
info_c <- sanitize( info[info$Mnemo == 'pmi_ci_url', c('Value')] )
r_its_query <- ifelse(
  grepl('^http', info[info$Mnemo == 'pmi_ci_url', c('Value')]),
  "Continuous integration is setup and information is provided in the PMI. ",
  "Continuous integration is either not setup or not correctly set in the PMI."
)
#cat(ci_ok)
```

\begin{itemize}
\item The project reference in Bugzilla (a.k.a. \textit{Product}) is `r sanitize( info[info$Mnemo == 'pmi_bugzilla_product', c('Value')] )`.
\item The list of issues for the project can be found at `r sanitize( info[info$Mnemo == 'pmi_bugzilla_query_url', c('Value')] )`. 
\item New issues on the project can be entered at `r sanitize( info[info$Mnemo == 'pmi_bugzilla_create_url', c('Value')] )`. 
\end{itemize}

At the time of analysis, there were `r metrics[metrics$Mnemo == 'ITS_OPENED', c('Value')]` opened issues, entered by `r metrics[metrics$Mnemo == 'ITS_OPENERS', c('Value')]` people, and `r metrics[metrics$Mnemo == 'ITS_CLOSED', c('Value')]` closed issues, fixed by `r metrics[metrics$Mnemo == 'ITS_CLOSERS', c('Value')]`.

During last month, `r metrics[metrics$Mnemo == 'ITS_CLOSED_30', c('Value')]` issues have been closed (`r metrics[metrics$Mnemo == 'ITS_DIFF_NETCLOSED_30', c('Value')]` compared to last month) by `r metrics[metrics$Mnemo == 'ITS_CLOSERS_30', c('Value')]` people (`r metrics[metrics$Mnemo == 'ITS_DIFF_NETCLOSERS_30', c('Value')]` compared to last month).

Measures have been retrieved from `r its.evol[1,c('date')]` up to `r tail(its.evol, 1)[c('date')]`. Here are a few stats:
\begin{itemize}
\item Month with most open bugs was `r its.evol[which(its.evol$opened == max(its.evol$openers)), c('date')]`.
\end{itemize}


```{r its_ggplot, echo=FALSE, fig.width=10, fig.height=4, eval=F}
my.data.long <- melt(its.evol[,c("unixtime", "opened", "closed")], id.vars="unixtime", value.name="value", variable.name="metric")
my.data.long$time <- as.POSIXct(as.numeric(as.character(my.data.long$unixtime)), origin="1970-01-01")

p <- ggplot(my.data.long, aes(x = time, y = value, color=metric)) + geom_line(size = .1) + theme_tufte()
p
```

# Appendices

## Metrics

Alambic retrieved `r nrow(metrics)` metrics from the defined data sources: 

```{r metrics, echo=F, message=FALSE, warnings=FALSE, results='asis'}
panderOptions('table.split.table', Inf)
set.caption( paste( "Metrics for project ", project.id, sep="" ) )
pandoc.table(metrics, style = 'grid', justify = c('left', 'left'))
```

## Attributes

Alambic retrieved `r nrow(attributes)` attributes from the defined data sources: 

```{r attributes, echo=F, message=FALSE, warnings=FALSE, results='asis'}
panderOptions('table.split.table', Inf)
set.caption( paste( "Quality attributes for project ", project.id, sep="" ) )
pandoc.table(attributes, style = 'grid', justify = c('left', 'left'))
```

## Recommendations

`r nrow(recs)` recommendations have been emitted for this project. 
\begin{tabularx}{\linewidth}{ll}
test & tes \\
\end{tabularx}

```{r recs, echo=F, message=FALSE, warnings=FALSE, results='asis'}
#
panderOptions('table.split.table', Inf)
set.caption( paste( "Recommendations for project ", project.id, sep="" ) )
pandoc.table(recs, style = 'multiline', justify = c('left', 'left', 'left'))
#
```

## Project metadata

This information is mostly retrieved from the Project Management Infrastructure repository. 

```{r info, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
panderOptions('table.split.table', Inf)
set.caption( paste( "Information for project ", project.id, sep="" ) )
pandoc.table( info, style = 'multiline', justify = c('left', 'left') )
```
