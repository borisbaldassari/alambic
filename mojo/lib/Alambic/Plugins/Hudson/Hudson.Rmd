---
title: "Hudson visualisation"
author:
- name: "Boris Baldassari"
  affiliation: Castalia Solutions
output:
  html_fragment:
    toc: false
    fig_caption: true
    fig.width: 800
    self_contained: false
    lib_dir: libs
    echo: false
    dev: svg
---

```{r init, echo=FALSE, message=FALSE}
project.id <- 'modeling.sirius'
plugin.id <- 'hudson'
file.main = paste("", project.id, "_hudson_main.csv", sep="")
file.jobs = paste("", project.id, "_hudson_jobs.csv", sep="")
file.builds = paste("", project.id, "_hudson_builds.csv", sep="")

library(knitr)
library(xts)
library(reshape2)

knitr::opts_chunk$set(fig.path = paste( 'figures/', plugin.id, '/', project.id, '/', sep=""))
#opts_knit$set(progress = TRUE, verbose = TRUE, self.contained=T)

require(ggplot2)
require(xtable)

main <- read.csv(file=file.main, header=T)
jobs <- read.csv(file=file.jobs, header=T)
builds <- read.csv(file=file.builds, header=T)
jobs$last_build_duration <- round(jobs$last_build_duration / 1000)
jobs$last_successful_build_duration <- round(jobs$last_successful_build_duration / 1000)
jobs$last_failed_build_duration <- round(jobs$last_failed_build_duration / 1000)
jobs$last_build_date <- as.POSIXct(jobs$last_build_time / 1000, origin="1970-01-01")
jobs$last_successful_build_date <- as.POSIXct(jobs$last_successful_build_time / 1000, origin="1970-01-01")
jobs$last_failed_build_date <- as.POSIXct(jobs$last_failed_build_time / 1000, origin="1970-01-01")
jobs.ok <- jobs[jobs$color == 'green',]
jobs.nok <- jobs[jobs$color == 'red',]
```

<div class="row">
<div class="col-md-6">

## Hudson Continuous Integration Engine

Hudson instance ``r main$name`` is located at ``r main$url``. ``r main$jobs`` are defined.

## Metrics

  <p>There are ``r metrics$JOBS`` jobs defined. ``r metrics$JOBS_GREEN`` are green (stable), ``r metrics$JOBS_YELLOW`` are yellow (unstable), ``r metrics$JOBS_RED`` are red (failing).</p>
  <p>Number of jobs failing for more than one week: ``r metrics$JOBS_FAILED_1W``.</p>
  <p>
```{r metrics_table, echo=FALSE, message=FALSE, results='asis'}
t <- lapply(names(metrics), function(x) paste(x, ' <span class="badge">', metrics[[x]], '</span>, ', sep=''))
t <- paste(t, collapse=" ")
cat(t)
```
  </p>
  <p>
  The following jobs have been failing for more than one week: <br />
  <ul>
```{r jobs_old, echo=FALSE, message=FALSE, results='asis'}
jobs.nok$since <- round(abs(jobs.nok$last_successful_build_date - Sys.time()))
jobs.nok.long <- jobs.nok[jobs.nok$since > 7,c('name', 'since')]
#print(jobs.nok.long[,c('name', 'since')])
t <- apply(jobs.nok.long, 1, function(x) paste('<li><code>', x[['name']], '</code> has been failing for <code>', x[['since']], '</code>. </li>', sep=''))
t <- paste(t, collapse=" ")
cat(t)
```
  </ul>
  </p>
</div>
<div class="col-md-6">
  <iframe src="/projects/figures/hudson/`r project.id`/hudson_pie.html" frameborder="0" style="width: 500px; height: 340px"></iframe>
</div>
</div>

### Jobs

List of failing jobs, sorted by last successful build.

<div class="panel panel-default">
<div class="panel-heading" style="background-color: #3E3F3A; color: white"><span class="fa fa-indent"></span>  OK jobs</div>
<table class="table table-striped">
  <tr><th>Name</th><th>Last Build</th><th>Last Duration</th><th>Params</th></tr>
```{r hudson_ok_jobs, echo=FALSE, message=FALSE, results='asis'}
t <- apply(jobs.ok, 1, 
           function(x) paste('<tr><td><i class="fa fa-thumbs-down"></i> ',
                             x[['name']], '</td><td><small>', x[['last_build_date']], 
                             '</small></td><td><small>', x[['last_build_duration']], 
                             ' sec.</small></td><td><span class="label label-success">',
                             x[['last_build_duration']], '</span>', ' <span class="label" style="background-color: #cc6686">',
                             x[['health_report']], '</span></td></tr>', sep=''))
t <- paste(t, collapse=" ")
cat(t)
```
</table>
</div>
</div>

<div class="panel panel-default">
<div class="panel-heading" style="background-color: #3E3F3A; color: white"><span class="fa fa-indent"></span>  Failing jobs</div>
<ul class="list-group">
```{r hudson_failing_jobs, echo=FALSE, message=FALSE, results='asis'}
t <- apply(jobs.nok, 1, 
           function(x) paste('<li class="list-group-item"><i class="fa fa-thumbs-down"></i> ',
                             x[['name']], ' <small>', x[['last_build_date']], '</small><span class="pull-right"><span class="label label-success">',
                             x[['last_build_duration']], ' ms</span>', ' <span class="label" style="background-color: #cc6686">',
                             x[['health_report']], '</span></span></li>', sep=''))
t <- paste(t, collapse=" ")
cat(t)
```
</ul>
</div>
</div>

### Changed


### People

### Opened vs Closed

```{r evol, echo=FALSE, message=FALSE, results='asis', eval=F}
#if (nrow(evol) < 2) {
#  print( "No historical data found.")
#} else {
  evol.xts <- xts(evol, order.by = as.POSIXct(evol$unixtime, origin="1970-01-01"))
  p <-dygraph(evol.xts[,c(2:8)]) %>% dyRangeSelector()
  p
#}
```



```{r static-gvis, echo=FALSE, message=FALSE, results='asis', eval=F}
suppressPackageStartupMessages(library(googleVis))
options(gvis.plot.tag='chart')
my.chart <- evol[,c(1:8)]
p <- gvisLineChart(my.chart, options = list(
      title="Bugs",
      width=500, height=350
      ))

print(p, 'chart')
```

```{r ggplot, echo=FALSE, message=F, results='asis', eval=F}
my.data.long <- melt(evol[,c("unixtime", "opened", "closed")], id.vars="unixtime", value.name="value", variable.name="metric")
my.data.long$time <- as.POSIXct(as.numeric(as.character(my.data.long$unixtime)), origin="1970-01-01")

p <- ggplot(my.data.long, aes(x = time, y = value, color=metric)) + geom_line(size = .1)
p
```


```{r test, echo=FALSE, message=FALSE, results='asis', eval=F}
scatterplot3js(data[,c(3,6,1)],
               labels=row.names(mtcars),    # mousing over a point will show what model car it is
               size=mtcars$hp/100,          # the size of a point maps to horsepower
               flip.y=TRUE,
               color=col,renderer="canvas") # point color indicates number of cylindars 

data(economics, package = "ggplot2")
econ <- transform(economics, date = as.character(date))
m1 <- mPlot(x = "date", y = c("psavert", "uempmed"), type = "Line", data = econ)
m1$set(pointSize = 0, lineWidth = 1)
m1$print("chart2")
```

