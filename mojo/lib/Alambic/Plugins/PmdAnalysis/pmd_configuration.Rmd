---
title: "PMD Configuration"
author:
- name: "Boris Baldassari"
  affiliation: Castalia Solutions
output:
  html_fragment:
    toc: false
    fig_caption: true
    fig.width: 800
    self_contained: false
    lib_dir: libs
    echo: false
    dev: svg
---

```{r init, echo=FALSE, message=FALSE}
project.id <- 'modeling.sirius'

library(knitr)

opts_chunk$set(fig.width=5, fig.height=5, echo=F, warning=F, message=F, fig.path = 'figures/')
#opts_knit$set(progress = TRUE, verbose = TRUE, self.contained=T)

require(ggplot2)
require(xtable)

priority.colours <- c("#CC0000", "#DD5500", "#EEAA00", "#FFCC66")

pmd.main <- read.csv(file=paste("", project.id, "_pmd_analysis_main.csv", sep=""), header=T)
pmd.rules <- read.csv(file=paste("", project.id, "_pmd_analysis_rules.csv", sep=""), header=T)
pmd.rulesets <- read.csv(file=paste("", project.id, "_pmd_analysis_rulesets2.csv", sep=""), header=T)
pmd.violations <- read.csv(file=paste("", project.id, "_pmd_analysis_violations.csv", sep=""), header=T)
pmd.files <- read.csv(file=paste("", project.id, "_pmd_analysis_files.csv", sep=""), header=T)
```

<h2>PMD Configuration analysis for `r I(project.id)`</h2>

<div class="row"><div class="col-sm-7">

<a href="http://pmd.sourceforge.net">PMD</a> is a great and widely-used source code analyzer which finds common programming flaws and bad coding practices in source code projects. This document intends to help users configure the tools and select the right rulesets for a more efficient use of the tool.

* The quick summary helps users <a href="#summary">understand the reports</a> generated by the tool
* The <a href="#improve-usage-rulesets">rulesets overview</a> provides basic information about the rulesets detected in the violations.
* The <a href="#improve-usage-rules">rules selection</a> section proposes to remove rules that produce too many violations to be actionable and have a low priority, to allow users to better focus on pragmatic actions.
* Finally, the <a href="#improve-usage-next">continuous improvement</a> section proposes steps to incrementally improve the quality of your project.

The version of PMD used is ``r pmd.main$PMD.version[1]`` and the PMD run was executed on the ``r as.POSIXct(pmd.main$Timestamp[1], format="%Y-%m-%dT%H:%M:%S")``. You can learn more about this module on its <a href="https://bitbucket.org/BorisBaldassari/alambic/wiki/Plugins/PMD%20Configuration">documentation page</a> on the <a href="https://bitbucket.org/BorisBaldassari/alambic/wiki/">project wiki</a>.

</div><div class="col-sm-4">

<div class="panel panel-success">
<!-- Default panel contents -->
<div class="panel-heading"><h3 class="panel-title">Contents</h3></div>
<div class="list-group">
  <a href="#summary" class="list-group-item">Quick Summary</a>
  <a href="#improve-usage-rulesets" class="list-group-item">Rulesets overview</a>
  <a href="#improve-usage-rules" class="list-group-item">Rules selection</a>
  <a href="#improve-usage-next" class="list-group-item">Continuous improvement</a>
  <!-- a href="#download" class="list-group-item">Download data</a -->
</div></div>

</div></div>

-----

<h3 id="summary">Quick Summary</h3>

<div class="row"><div class="col-sm-6">

PMD raised a total of ``r sum(pmd.main$NCC)`` violations to checked rules, including:

* ``r sum(pmd.files$NCC_1)`` with <span style="color: #CC0000">priority 1</span>,
* ``r sum(pmd.files$NCC_2)`` with <span style="color: #DD5500">priority 2</span>,
* ``r sum(pmd.files$NCC_3)`` with <span style="color: #EEAA00">priority 3</span>,
* ``r sum(pmd.files$NCC_4)`` with <span style="color: #FFCC66">priority 4</span>. 

<strong>Rules</strong> can be considered as <em>coding practices</em>. They represent what the community believes to be right or wrong, althougth it heavily depends on your own context. In this very case:</p>

* A total of `r sum(pmd.main$RULES)` rules have been checked.
* The analysis found `r sum(pmd.main$RKO)` broken rules, and ``r sum(pmd.main$ROK)`` respected rules.
* So the rate of <strong>acquired practices</strong> is ``r round(sum(pmd.main$ROKR), digits=1)`` %.

</div><div class="col-sm-6">

This plot shows the proportion of rules violated (<span class="label" style="background-color: #CC0000">NOK: red</span>) and clean (<span class="label" style="background-color: #325d88">OK: blue</span>). The lightness decreases with the priority (P1 -> p4).</p>

<iframe src="/projects/`r project.id`/PmdAnalysis/pmd_configuration_summary_pie.html" frameborder="0" style="width: 100%; height: 320px"></iframe>

</div></div>

-----

<h3 id="improve-usage">Improving PMD usage</h3>

Having too many violations just doesn't help. Most developers will feel overwhelmed by thousands of violations, and from a practical point of view they just won't spend days or weeks fixing violations on a product that works -- would you yourself?

That's why it is important to <a href="http://pmd.sourceforge.net/bestpractices.html">customise PMD to fit your needs</a>. It usually boils down to the following steps.

<h4 id="improve-usage-rulesets">Investigate rulesets</h4>

If you are quite new to PMD, the first thing to do is to <em>investigate and try the rulesets</em>. Start with some of the obvious rulesets - just run <a href="http://pmd.sourceforge.net/rules/unusedcode.html">unusedcode</a> and fix any unused locals and fields. Then, run <a href="http://pmd.sourceforge.net/rules/basic.html">basic</a> and fix all the empty <code>if</code> statements and such-like. Then peruse the <a href="http://pmd.sourceforge.net/rules/unusedcode.html">design</a>, <a href="http://pmd.sourceforge.net/rules/coupling.html">coupling</a> and <a href="http://pmd.sourceforge.net/rules/controversial.html">controversial</a> rulesets.

The bottom line is to find rules that are both **important** - you can rely on the <i>priority</i> of the rule for that - and <strong>actionable</strong>, that is they do not show thousands of violations. The latter is because beside the fact it is discouraging for developers, it means that your project is probably not mature enough regarding this practice. **Start small, secure practices, and expand the scope**.

The rulesets detected in the current PMD log are ``r paste(unique(pmd.rulesets$ruleset), sep=", ")``, which represent a total of ``r sum(pmd.main$RULES)`` practices checked. The following graphic shows <em>the number of violations classified by ruleset</em>. Violations are sorted according to their priority, from 1 (high impact) to 4 (information). The table on the right provides the data for this graph, with the overall number of violations for each ruleset, and for each priority.


<div class="row"><div class="col-lg-6">

<img src="/projects/`r project.id`/PmdAnalysis/pmd_configuration_rulesets_repartition.svg" frameborder="0" style="width: 100%; height: 540px" />

</div><div class="col-sm-6">

```{r rulesets-repartition-table, results='asis', warning=F}
# Create data.frame
tmp.rulesets <- data.frame(unique(pmd.rulesets$ruleset))
names(tmp.rulesets) <- c('ruleset')

# Add NCC_1, NCC_2, NCC_3, NCC_4 vol from columns with priority
tmp.rulesets <- merge(x=tmp.rulesets,
                     y=subset(pmd.rulesets, priority == 1)[-2],
                     by="ruleset", all=TRUE)
tmp.rulesets <- merge(x=tmp.rulesets,
                     y=subset(pmd.rulesets, priority == 2)[-2],
                     by="ruleset", all=TRUE)
tmp.rulesets <- merge(x=tmp.rulesets,
                     y=subset(pmd.rulesets, priority == 3)[-2],
                     by="ruleset", all=TRUE)
tmp.rulesets <- merge(x=tmp.rulesets,
                     y=subset(pmd.rulesets, priority == 4)[-2],
                     by="ruleset", all=TRUE)

# Replace NAs with zeros
tmp.rulesets[is.na(tmp.rulesets)] <- 0

# Add sum in NCC column
tmp.rulesets$NCC <- rowSums(tmp.rulesets[,2:4])

# Rename columns
names(tmp.rulesets) <- c('Ruleset', 'NCC_1', 'NCC_2', 'NCC_3', 'NCC_4', 'NCC')

# Rebuild final data frame
tmp.rulesets.final <- tmp.rulesets[,c('Ruleset', 'NCC', 'NCC_1', 'NCC_2', 'NCC_3', 'NCC_4')]

print(
    xtable(tmp.rulesets.final, digits=0,
        caption = 'Rulesets detected in this PMD analysis.'),
    type="html",
    html.table.attributes='class="table table-striped"',
    include.rownames=FALSE
)
```

</div></div>

<h4 id="improve-usage-rules">Select and customise rules</h4>

Once you get to know what rules are available, and started identify some of them as really smart and relevant for you, you should then <a href="http://pmd.sourceforge.net/howtomakearuleset.html">create your own ruleset</a>. Creating your own ruleset makes it easier to run PMD by selecting entire rulesets, excluding or specifically adding specific rules. It also gives you more control over the execution, e.g. by excluding some files or directories.

The following graphic shows all rules violated in this project's code, sorted according to the number of violations. The colour of the bars varies from <span style="color: #CC0000">red</span> (priority 1) to <span style="color: #FFCC66">yellow</span> (priority 4). Please note that the y axis is logarithmic, so small numbers can still be identified despite the high-volume rules.

<img src="/projects/`r project.id`/PmdAnalysis/pmd_configuration_violations_rules.svg" frameborder="0" style="width: 100%; height: 600px" />

```{r violations-rules}

pmd.violations.sorted <- pmd.violations[order(pmd.violations$vol),]
pmd.violations.sorted$csum <- cumsum(pmd.violations.sorted$vol)

# Get the threshold for rules that have priority > 2 and many violations.
pmd.violations.threshold <- head(pmd.violations.sorted[pmd.violations.sorted$priority >= 3 & pmd.violations.sorted$vol > 500,c(5)], n=1)

exclude.rules <- pmd.violations.sorted[pmd.violations.sorted$csum >= pmd.violations.threshold,c(1,2,4)]
pmd.violations.removed <- sum(exclude.rules$vol)
exclude.rules <- exclude.rules[with(exclude.rules, order(-vol)),]
```

<div class="row"><div class="col-lg-6">

At least during the early steps, rules with a high number of violations (e.g. > 500) and a low priority (e.g. 3 and 4) can simply be discarded. On the above plot, they correspond to all yellow bars to the right of the last right red or orange bar. In the current case there are `r length(exclude.rules$Mnemo)` rules that can be excluded, which represent together ``r pmd.violations.removed`` violations. They are listed in the table on the right. By removing these rules, the number of violations should fall down from ``r sum(pmd.main$NCC)`` to ``r pmd.violations.threshold``.

If some rules seem to be relevant but give unexpected results, try to tune them. Many rules can be given properties to alter their behaviour. As an example, the <a href="http://pmd.sourceforge.net/rules/basic.html#EmptyCatchBlock">EmptyCatchBlock</a> rule from the <a href="http://pmd.sourceforge.net/rules/basic.html">basic ruleset</a> has a Java property <code>allowCommentedBlocks</code> to skip empty blocks  comments for this rule.

</div><div class="col-lg-6">

```{r violations-rules-table, results='asis', warning=F}
print(
  xtable(
    exclude.rules,
    caption = 'Rules that can be removed to lower the number of violations.',
    digits=0), 
  type="html",
  html.table.attributes='class="table table-striped"',
  caption.placement='bottom',
  include.rownames=FALSE
)
```

</div></div>

<h4 id="improve-usage-next">Continuous improvement</h4>

Well, if you did that already you should have a much more concise and clean perspective on PMD results. Improving the project quality is probably the best thing to do now, at least to catch the most important bugs (i.e. with the highest priority). Once you are done, come back to this section and try to add some more meaningful rules to continuously improve your code.

<br />