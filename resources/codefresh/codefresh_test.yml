version: '1.0'

steps:

  build_test_image:
    title: Building Test Image
    description: Build Test Image desc...
    image: bbaldassari/alambic_base_centos:latest
    working_directory: /home/alambic/
    commands:
      - su - alambic -c 'git clone https://bitbucket.org/BorisBaldassari/alambic.git /home/alambic/alambic'
      - su - alambic -c 'cd /home/alambic/alambic && git checkout master && git branch && git status'
      - su - alambic -c 'cp /home/alambic/alambic/docker/image_test/alambic.conf /home/alambic/alambic/mojo/'

  run_test_image:
    title: Run Test Image
    type: composition
    composition:
      version: '2'
      services:
        postgres:
          image: 'postgres:9.5'
          container_name: postgres
          environment:
            POSTGRES_PASSWORD: pass4alambic
            POSTGRES_USER: alambic
    composition_candidates:
      alambic_test:
        image: ${{build_test_image}}
        command:
          - su - alambic -c "sh /home/alambic/alambic/docker/image_test/alambic_test.sh"
          - su - alambic -c "sh /home/alambic/alambic/resources/scripts/alambic_test_ui.sh"

  push_test_to_registry:
    title: Pushing to Docker Registry
    description: Pushing Test Image desc...
    type: push

    # A candidate is the image that we want to push to registry
    candidate: '${{build_test_image}}'

    # You can push the image with whatever tag you want. In our example we use CF_BRANCH, which is a variable in
    # the build process, accessible throughout the entire flow.
    tag: latest # '${{CF_BRANCH}}'

